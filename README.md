# SecureOTP

A military-grade .NET library for implementing Time-based One-Time Passwords (TOTP) with Google Authenticator compatibility. Features encrypted secret storage, QR code generation, real-time memory encryption, and sandboxed executable proxying.

[![NuGet Version](https://img.shields.io/nuget/v/SecureOTP)](https://www.nuget.org/packages/SecureOTP)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

## ๐ Features

### Core TOTP Functionality
- ๐ **AES-256 Encryption**: PBKDF2 key derivation with 100,000 iterations
- ๐ฑ **Google Authenticator Compatible**: Full RFC 6238 TOTP compliance
- ๐ **QR Code Generation**: Create `otpauth://` URIs for easy phone app setup
- ๐พ **Persistent Storage**: Secure file-based storage with atomic operations
-  **Time Window Support**: Clock skew tolerance with configurable windows
- ๐ **Multi-Account Management**: Handle multiple TOTP accounts simultaneously

### Advanced Security Features
- ๐ **Real-Time Memory Encryption**: ChaCha20-Poly1305 with 100ms key rotation
- ๐ก๏ธ **Encrypted Executable Proxy**: Store executables encrypted, decrypt only in memory
- ๐ซ **Sandboxed Execution**: Prevent external access to encrypted components
- ๐งน **Secure Memory Wiping**: Automatic cleanup with RandomNumberGenerator.Fill()
- ๐ **Forward Secrecy**: Old encryption keys destroyed every 100ms
- ๐ **Stack Trace Validation**: Prevent unauthorized external execution

## Installation

```bash
dotnet add package SecureOTP
```

## ๐ Quick Start

### Basic TOTP Usage

```csharp
using SecureOTP;

// Initialize with your master encryption key
var encryptionKey = "your-secure-master-key-here";
var totpManager = new TotpManager(encryptionKey);

// Create a new TOTP account
var result = totpManager.CreateAccount("user@example.com", "MyApp");
if (result.Success)
{
    Console.WriteLine($"๐ฑ QR Code: {result.QrCodeUri}");
    Console.WriteLine("Scan this with Google Authenticator");
}

// Generate current TOTP code
var codeResult = totpManager.GenerateCode("user@example.com");
if (codeResult.Success)
{
    Console.WriteLine($"๐ข Current code: {codeResult.Code}");
    Console.WriteLine($"โฑ๏ธ Expires in: {codeResult.RemainingSeconds} seconds");
}

// Verify a code from user's phone
var verification = totpManager.VerifyCode("user@example.com", "123456");
Console.WriteLine($"โ Valid: {verification.IsValid}");
```

### Real-Time Memory Encryption

```csharp
using SecureOTP;

// Initialize with real-time memory protection
using var memoryVault = new AdvancedMemoryEncryption("memory-key-2024");

// Store sensitive data with multiple encryption layers
var commandId = memoryVault.StoreCommandInMemory(sensitiveData, "my-command");

// Data is now protected with:
// - ChaCha20-Poly1305 encryption per segment  
// - XOR obfuscation with rotating keys
// - Key rotation every 100ms
// - Segmented storage (1KB chunks)

// Retrieve when needed (decrypts temporarily)
var decrypted = memoryVault.RetrieveCommand(commandId);

// Secure cleanup (wipes all traces)
memoryVault.WipeCommand(commandId);
```

### Encrypted Executable Proxy

```csharp
using SecureOTP;

// Initialize encrypted executable manager
using var proxy = new EncryptedExecutableProxy("execution-key-2024");

// One-time setup: encrypt an executable for secure storage
await proxy.EncryptAndStoreExecutable("/usr/bin/google-authenticator", "google-auth");

// Execute through proxy (executable never exposed externally)
var result = await proxy.ProxyGoogleAuthenticator("setup", "user@example.com");
if (result.Success)
{
    Console.WriteLine($"๐ฑ QR URI: {result.QrCodeUri}");
}

var codeResult = await proxy.ProxyGoogleAuthenticator("generate", "user@example.com");
Console.WriteLine($"๐ข Code: {codeResult.Code}");

var verifyResult = await proxy.ProxyGoogleAuthenticator("verify", "user@example.com", "123456");
Console.WriteLine($"โ Valid: {verifyResult.IsValid}");
```

### Advanced Usage with Logging

```csharp
using Microsoft.Extensions.Logging;
using SecureOTP;

// Setup logging
using var loggerFactory = LoggerFactory.Create(builder => builder.AddConsole());
var logger = loggerFactory.CreateLogger<TotpManager>();

// Initialize with custom storage path and logging
var totpManager = new TotpManager(
    encryptionKey: "your-master-key", 
    storageFilePath: "/secure/path/totp_accounts.json",
    logger: logger
);

// Import existing secret with logging
var importResult = totpManager.ImportAccount(
    accountName: "existing@service.com",
    plainSecret: "JBSWY3DPEHPK3PXP",
    issuer: "ExternalService"
);
```

## ๐ Security Architecture

### Multi-Layer Protection

```
โโ External Access โโ    โโ Application Layer โโ    โโ Memory Layer โโ    โโ Storage Layer โโ
โ                   โ    โ                     โ    โ                โ    โ                โ
โ โ Terminal       โ    โ โ Your App         โ    โ ๐ ChaCha20     โ    โ ๐ AES-256     โ
โ โ SSH           โ -> โ โ Stack Validated   โ -> โ ๐ Key Rotation  โ -> โ ๐ PBKDF2      โ
โ โ Direct Exec   โ    โ โ Sandboxed        โ    โ ๐งน Auto Wipe    โ    โ ๐พ Atomic I/O  โ
โ                   โ    โ                     โ    โ                โ    โ                โ
โโโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโ
```

### Key Features

- **๐ซ Zero External Access**: Executables cannot be run from terminal/SSH
- **๐ Real-Time Encryption**: < 1ms plaintext exposure in memory  
- **๐ Key Rotation**: New encryption keys every 100ms
- **๐งน Secure Wiping**: RandomNumberGenerator.Fill() overwrites
- **๐ Forward Secrecy**: Old keys destroyed automatically
- **๐ก๏ธ Stack Validation**: Prevents unauthorized code execution

// Generate current TOTP code
string currentCode = totpService.GenerateCode(encryptedSecret);

// Verify code with 1-step tolerance (30 seconds before/after)
bool isValid = totpService.VerifyCode(encryptedSecret, userEnteredCode, windowSteps: 1);
```

## API Reference

### TotpManager

The main class for complete TOTP account management.

#### Methods

- `CreateAccount(accountName, issuer)` - Create new TOTP account
- `ImportAccount(accountName, plainSecret, issuer, overwrite)` - Import existing secret
- `GenerateCode(accountName)` - Generate current TOTP code
- `VerifyCode(accountName, code, windowSteps)` - Verify TOTP code
- `GetQrCodeUri(accountName, issuer)` - Get QR code URI for existing account
- `RemoveAccount(accountName)` - Remove account
- `ListAccounts()` - List all account names
- `GetAccountsInfo()` - Get detailed account information
- `AccountExists(accountName)` - Check if account exists

### TotpService

Core TOTP operations without persistent storage.

#### Methods

- `GenerateNewSecret()` - Generate new encrypted secret
- `GenerateCode(encryptedSecret)` - Generate TOTP code
- `VerifyCode(encryptedSecret, code, windowSteps)` - Verify TOTP code
- `GetProvisioningUri(encryptedSecret, accountName, issuer)` - Get QR code URI
- `ImportSecret(plainSecret)` - Import and encrypt existing secret
- `GetRemainingTimeForCurrentCode()` - Get seconds until current code expires

### TotpStorage

Persistent storage for encrypted TOTP secrets.

#### Methods

- `StoreAccount(accountName, encryptedSecret)` - Store account
- `GetAccountSecret(accountName)` - Retrieve encrypted secret
- `RemoveAccount(accountName)` - Remove account
- `ListAccounts()` - List account names
- `GetAccountsInfo()` - Get account information
- `AccountExists(accountName)` - Check existence

## Security Features

### Encryption
- **Algorithm**: AES-256-CBC
- **Key Derivation**: PBKDF2 with SHA-256 (100,000 iterations)
- **Salt**: Consistent application salt for key derivation
- **IV**: Random IV for each encryption operation

### Storage Security
- **Atomic Writes**: Temporary file + move for consistency
- **File Permissions**: Restricted to owner only (Unix systems)
- **No Plain Text**: Secrets never stored unencrypted
- **JSON Format**: Structured storage with metadata

### TOTP Compliance
- **Standard**: RFC 6238 Time-Based One-Time Password
- **Algorithm**: HMAC-SHA1 (Google Authenticator compatible)
- **Time Step**: 30 seconds
- **Code Length**: 6 digits
- **Base32 Encoding**: Standard secret encoding

## Configuration

### Encryption Key Management

**Production**: Use a secure, persistent encryption key:

```csharp
// From environment variable
var encryptionKey = Environment.GetEnvironmentVariable("TOTP_MASTER_KEY");

// From configuration
var encryptionKey = configuration["Security:TotpMasterKey"];

// From secure key store
var encryptionKey = await keyVault.GetSecretAsync("totp-master-key");
```

**Development**: Generate a test key:

```csharp
// WARNING: Only for testing!
var totpService = new TotpService(); // Uses auto-generated key
```

### Storage Options

```csharp
// Default: ./totp_accounts.json
var manager = new TotpManager(encryptionKey);

// Custom path
var manager = new TotpManager(encryptionKey, "/secure/path/accounts.json");

// In-memory only (no persistence)
var service = new TotpService(encryptionKey);
```

## Error Handling

The library throws specific exceptions for different error conditions:

```csharp
try
{
    var result = totpManager.CreateAccount("user@example.com");
}
catch (ArgumentException ex)
{
    // Invalid parameters (null/empty account name, etc.)
}
catch (InvalidOperationException ex)
{
    // Business logic errors (account already exists, etc.)
}
catch (Exception ex)
{
    // Unexpected errors (file system, crypto, etc.)
}
```

## Integration Examples

### ASP.NET Core Web API

```csharp
// Startup.cs / Program.cs
builder.Services.AddSingleton<TotpManager>(provider => 
{
    var config = provider.GetRequiredService<IConfiguration>();
    var logger = provider.GetRequiredService<ILogger<TotpManager>>();
    var encryptionKey = config["Security:TotpMasterKey"];
    return new TotpManager(encryptionKey, logger: logger);
});

// Controller
[ApiController]
[Route("api/[controller]")]
public class TotpController : ControllerBase
{
    private readonly TotpManager _totpManager;

    public TotpController(TotpManager totpManager)
    {
        _totpManager = totpManager;
    }

    [HttpPost("setup")]
    public IActionResult SetupTotp([FromBody] SetupRequest request)
    {
        var result = _totpManager.CreateAccount(request.AccountName, "MyApp");
        return Ok(new { qrCodeUri = result.QrCodeUri });
    }

    [HttpPost("verify")]
    public IActionResult VerifyTotp([FromBody] VerifyRequest request)
    {
        var result = _totpManager.VerifyCode(request.AccountName, request.Code);
        return Ok(new { isValid = result.IsValid });
    }
}
```

### Console Application

```csharp
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.DependencyInjection;
using SecureOTP;

var host = Host.CreateDefaultBuilder(args)
    .ConfigureServices(services =>
    {
        services.AddSingleton<TotpManager>(provider =>
        {
            var logger = provider.GetService<ILogger<TotpManager>>();
            return new TotpManager("your-encryption-key", logger: logger);
        });
    })
    .Build();

var totpManager = host.Services.GetRequiredService<TotpManager>();

// Your application logic
var result = totpManager.CreateAccount("console-app@example.com");
Console.WriteLine($"Scan this QR code: {result.QrCodeUri}");
```

## Migration from Existing Systems

### From Google Authenticator Export

```csharp
// If you have existing Base32 secrets
var totpManager = new TotpManager("encryption-key");

// Import each account
totpManager.ImportAccount("service1@example.com", "JBSWY3DPEHPK3PXP", "Service1");
totpManager.ImportAccount("service2@example.com", "MFRGG2DFMZTWQ2LK", "Service2");
```

### From Other TOTP Libraries

```csharp
// Extract secrets from your existing system
var existingSecrets = GetExistingTotpSecrets();

var totpManager = new TotpManager("new-encryption-key");

foreach (var (accountName, secret) in existingSecrets)
{
    totpManager.ImportAccount(accountName, secret, "MyApp");
}
```

## Testing

### Unit Testing with Mock Data

```csharp
[Test]
public void VerifyCode_WithValidCode_ReturnsTrue()
{
    // Arrange
    var totpService = new TotpService("test-key");
    var encryptedSecret = totpService.GenerateNewSecret();
    var currentCode = totpService.GenerateCode(encryptedSecret);

    // Act
    var isValid = totpService.VerifyCode(encryptedSecret, currentCode);

    // Assert
    Assert.IsTrue(isValid);
}
```

### Integration Testing

```csharp
[Test]
public void CompleteWorkflow_CreateVerifyRemove_WorksCorrectly()
{
    // Arrange
    var tempPath = Path.GetTempFileName();
    var totpManager = new TotpManager("test-key", tempPath);

    try
    {
        // Act & Assert
        var result = totpManager.CreateAccount("test@example.com");
        Assert.IsTrue(result.Success);

        var codeResult = totpManager.GenerateCode("test@example.com");
        Assert.IsTrue(codeResult.Success);

        var verification = totpManager.VerifyCode("test@example.com", codeResult.Code);
        Assert.IsTrue(verification.IsValid);

        var removed = totpManager.RemoveAccount("test@example.com");
        Assert.IsTrue(removed);
    }
    finally
    {
        File.Delete(tempPath);
    }
}
```

## ๐ Examples & Testing

### Running the Tests

The repository includes two key test examples:

#### 1. Real-Time Memory Encryption Flow Test
```bash
cd StandaloneFlowTest
dotnet run
```
**Demonstrates**: 8KB executable encryption โ memory protection โ key rotation โ secure retrieval

#### 2. Complete TOTP Workflow Test  
```bash
cd StandaloneTotpTest  
dotnet run
```
**Demonstrates**: QR generation โ code generation โ verification โ multi-account โ performance

### Test Results Summary
```
๐ Real-Time Encryption Flow Test
=================================
โ Plaintext exposure: < 1ms
โ Memory protection: AES-256 encryption at rest  
โ Key rotation: Every 100ms with secure wipe
โ Data integrity: PASSED after encryption/decryption
โ Automatic cleanup: All memory wiped on disposal

๐ Complete TOTP Workflow Test  
=============================
โ QR Code Generation - WORKING (otpauth:// URI)
โ Code Generation - WORKING (6-digit RFC 6238)
โ Code Verification - WORKING (with clock skew tolerance)  
โ Invalid Rejection - WORKING (rejects 123456)
โ Multi-Account - WORKING (isolated secrets)
โ Performance - WORKING (0.06ms per operation)
```

## โก Performance Benchmarks

- **TOTP Operations**: ~0.06ms per generate+verify cycle
- **Memory Encryption**: ~1ms for 8KB executable encryption  
- **Key Rotation**: Every 100ms (automatic background)
- **File I/O**: Atomic writes with temporary files
- **Memory Usage**: Minimal - automatic secure cleanup
- **Concurrent Access**: Thread-safe with proper locking

## ๐ง Troubleshooting

### Common Issues

**TOTP Code Issues**:
- โ Check system time synchronization (critical for TOTP)
- โ Verify clock skew tolerance with time window settings
- โ Ensure secret wasn't corrupted during storage/import

**Memory Encryption Issues**:
- โ Verify sufficient memory for segmented storage  
- โ Check key rotation timer disposal on application shutdown
- โ Ensure proper using statements for automatic cleanup

**Executable Proxy Issues**:
- โ Verify executable exists before encryption
- โ Check file permissions for temp directory creation
- โ Ensure stack trace validation allows your calling code

**File Storage Issues**:
- โ Ensure write permissions to storage directory
- โ Check file ownership and permissions (Unix systems)
- โ Verify encryption key consistency across sessions

**Performance Issues**:
- โ Use `using` statements for proper disposal
- โ Avoid creating multiple instances unnecessarily
- โ Monitor memory usage with long-running applications

### Security Validation

**Test Memory Protection**:
```bash
# Run the memory encryption flow test
cd StandaloneFlowTest && dotnet run
# Should show < 1ms plaintext exposure
```

**Test TOTP Workflow**:  
```bash
# Run complete TOTP functionality test
cd StandaloneTotpTest && dotnet run
# Should complete all 8 workflow steps successfully
```

## ๐ Project Structure

```
SecureOTP/
โโโ ๐ Core Library
โ   โโโ TotpManager.cs              # High-level TOTP management
โ   โโโ TotpService.cs              # Core TOTP cryptography  
โ   โโโ TotpStorage.cs              # Encrypted persistent storage
โ   โโโ SecureOTP.csproj            # Main library project
โ
โโโ ๐ Advanced Security
โ   โโโ AdvancedMemoryEncryption.cs # ChaCha20 + key rotation
โ   โโโ SimpleMemoryEncryption.cs   # Simplified memory protection
โ   โโโ EncryptedExecutableProxy.cs # Encrypted executable management
โ   โโโ SandboxedTotpService.cs     # Sandboxed execution model
โ   โโโ InternalTotpAPI.cs          # Internal-only API access
โ
โโโ ๐งช Test Examples
โ   โโโ StandaloneFlowTest/         # Real-time encryption flow test
โ   โโโ StandaloneTotpTest/         # Complete TOTP workflow test
โ
โโโ ๐ Documentation  
    โโโ README.md                   # This comprehensive guide
    โโโ LICENSE                     # MIT license
    โโโ .gitignore                  # Git ignore rules
```

## ๐ค Contributing

Contributions are welcome! This project focuses on:

- ๐ **Security First**: All changes must maintain or improve security
- โก **Performance**: Keep operations fast (< 1ms for core functions)  
- ๐ **Documentation**: Update README.md for any API changes
- ๐งช **Testing**: Include tests demonstrating new functionality

Please submit pull requests with clear descriptions and test coverage.

## ๐ License

This project is licensed under the MIT License - see the LICENSE file for details.

## ๐ Security Disclosure

For security-related issues, please email security@ewdhp.dev instead of using the public issue tracker.

---

**Built with โค๏ธ for maximum security and performance**